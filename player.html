<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Player Seguro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    body { background: #000; margin: 0; }
    video { width: 100vw; height: 100vh; background: #000; }
    #loading {
        position: fixed; top: 0; left: 0;
        width: 100%; height: 100%;
        background: #000; color: #fff;
        display: flex; align-items: center; justify-content: center;
        font-size: 22px;
    }
</style>
</head>
<body>

<div id="loading">Carregando vídeo…</div>
<video id="video" controls autoplay></video>

<script>
(async () => {
    const hash = decodeURIComponent(location.hash.substring(1));
    if (!hash) {
        alert("Nenhum link encontrado na URL.");
        return;
    }

    const video = document.getElementById("video");

    // Detecta se é HLS (.m3u8)
    const isHLS = hash.includes(".m3u8");

    // 1) HLS-DOWNLOADER invisível (segmentos ficam em cache local)
    async function preloadHLS(url) {
        try {
            const m3u8 = await fetch(url);
            const text = await m3u8.text();

            const lines = text.split("\n")
                .filter(l => l.trim() && !l.startsWith("#"));

            const base = url.split("/").slice(0, -1).join("/");

            // Baixa segmentos silenciosamente para cache local
            for (const seg of lines) {
                fetch(base + "/" + seg).catch(()=>{});
            }

        } catch (e) {
            console.log("Falha no preloader:", e);
        }
    }

    // 2) Usa HLS.js se for m3u8
    if (isHLS) {
        const script = document.createElement("script");
        script.src = "https://cdn.jsdelivr.net/npm/hls.js@latest";
        script.onload = async () => {

            // Pré-carrega invisível (salva segmentação do filme)
            preloadHLS(hash);

            if (Hls.isSupported()) {
                const hls = new Hls({
                    maxBufferLength: 60,
                    maxMaxBufferLength: 120,
                    liveSyncDuration: 30
                });
                hls.loadSource(hash);
                hls.attachMedia(video);
                video.oncanplay = () => {
                    document.getElementById("loading").style.display = "none";
                    video.play();
                };
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = hash;
                video.addEventListener("loadedmetadata", () => {
                    document.getElementById("loading").style.display = "none";
                    video.play();
                });
            }
        };
        document.body.appendChild(script);

    } else {
        // Se for MP4 direto, só roda
        video.src = hash;
        video.addEventListener("loadedmetadata", () => {
            document.getElementById("loading").style.display = "none";
        });
    }
})();
</script>

</body>
</html>
